name: CD (Publish to npm)

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        default: patch
        options:
          - patch
          - minor
          - major
          - none
      preid:
        description: "Pre-release id (e.g. beta, rc). Leave blank for stable"
        required: false
        type: string

permissions:
  contents: write
  id-token: write
  attestations: write

concurrency:
  group: npm-cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install deps
        run: npm ci --no-fund --no-audit --legacy-peer-deps

      - name: Test (coverage)
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        if: ${{ hashFiles('coverage/lcov.info') != '' }}
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          use_oidc: true
          fail_ci_if_error: false

      - name: Build
        run: npm run build --if-present

      - name: Prepare release metadata
        id: release
        env:
          BUMP: ${{ inputs.bump }}
          PREID: ${{ inputs.preid }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_ACCESS=$(node -p "(require('./package.json').publishConfig||{}).access||''")
          CURRENT_VERSION=$(node -p "require('./package.json').version")

          SHOULD_PUSH="false"

          case "${BUMP:-patch}" in
            major|minor|patch)
              if [ -n "${PREID:-}" ]; then
                case "${BUMP}" in
                  major) npm version premajor --preid "${PREID}" -m "chore: release v%s [skip ci]" ;;
                  minor) npm version preminor --preid "${PREID}" -m "chore: release v%s [skip ci]" ;;
                  patch) npm version prepatch --preid "${PREID}" -m "chore: release v%s [skip ci]" ;;
                esac
              else
                npm version "${BUMP}" -m "chore: release v%s [skip ci]"
              fi
              SHOULD_PUSH="true"
              ;;
            none)
              echo "No version bump requested."
              ;;
            *)
              echo "Unknown bump type: ${BUMP}" >&2
              exit 1
              ;;
          esac

          RELEASE_VERSION=$(node -p "require('./package.json').version")
          RELEASE_TAG="v${RELEASE_VERSION}"

          if ! git rev-parse "${RELEASE_TAG}" >/dev/null 2>&1; then
            git tag "${RELEASE_TAG}"
            SHOULD_PUSH="true"
          fi

          if npm view "${PACKAGE_NAME}@${RELEASE_VERSION}" version --registry https://registry.npmjs.org >/dev/null 2>&1; then
            echo "Version already exists on npm: ${PACKAGE_NAME}@${RELEASE_VERSION}" >&2
            exit 1
          fi

          echo "package_name=${PACKAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "package_access=${PACKAGE_ACCESS}" >> "$GITHUB_OUTPUT"
          echo "release_version=${RELEASE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "release_tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "should_push=${SHOULD_PUSH}" >> "$GITHUB_OUTPUT"

          echo "Prepared release ${PACKAGE_NAME}@${RELEASE_VERSION} (${RELEASE_TAG})"

      - name: Generate SBOM (CycloneDX)
        run: npm sbom --sbom-format=cyclonedx --sbom-type=library --omit dev > sbom.cdx.json
        continue-on-error: true

      - name: Attest SBOM
        if: ${{ hashFiles('sbom.cdx.json') != '' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: sbom.cdx.json

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          PACKAGE_ACCESS: ${{ steps.release.outputs.package_access }}
        run: |
          set -euo pipefail

          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "NPM_TOKEN is required" >&2
            exit 1
          fi

          if [ "${PACKAGE_ACCESS}" = "public" ]; then
            npm publish --access public --provenance --registry https://registry.npmjs.org
          else
            npm publish --provenance --registry https://registry.npmjs.org
          fi

      - name: Push release commit and tag
        if: ${{ steps.release.outputs.should_push == 'true' }}
        run: |
          set -euo pipefail
          git push
          git push --tags

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.release.outputs.release_tag }}
        run: |
          set -euo pipefail

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists"
          else
            gh release create "$TAG" --title "Release $TAG" --generate-notes --latest
          fi

          if [ -f sbom.cdx.json ]; then
            gh release upload "$TAG" sbom.cdx.json --clobber
          fi
